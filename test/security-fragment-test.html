<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>api-documentation test</title>

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
  <script src="../../../mocha/mocha.js"></script>
  <script src="../../../chai/chai.js"></script>
  <script src="../../../wct-mocha/wct-mocha.js"></script>
  <script src="../../../sinon/pkg/sinon.js"></script>

  <script src="./amf-loader.js"></script>

  <script src="../../../jsonlint/lib/jsonlint.js"></script>
  <script src="../../../codemirror/lib/codemirror.js"></script>
  <script src="../../../codemirror/addon/mode/loadmode.js"></script>
  <script src="../../../codemirror/mode/meta.js"></script>
  <script src="../../../codemirror/mode/javascript/javascript.js"></script>
  <script src="../../../codemirror/mode/xml/xml.js"></script>
  <script src="../../../codemirror/mode/htmlmixed/htmlmixed.js"></script>
  <script src="../../../codemirror/addon/lint/lint.js"></script>
  <script src="../../../codemirror/addon/lint/json-lint.js"></script>
  <script src="../../../@advanced-rest-client/code-mirror-hint/headers-addon.js"></script>
  <script src="../../../@advanced-rest-client/code-mirror-hint/show-hint.js"></script>
  <script src="../../../@advanced-rest-client/code-mirror-hint/hint-http-headers.js"></script>

  <script>
  /* global CodeMirror */
  CodeMirror.modeURL = '../../../codemirror/mode/%N/%N.js';
  </script>

  <script src="../../../cryptojslib/components/core.js"></script>
  <script src="../../../cryptojslib/rollups/sha1.js"></script>
  <script src="../../../cryptojslib/components/enc-base64-min.js"></script>
  <script src="../../../cryptojslib/rollups/md5.js"></script>
  <script src="../../../cryptojslib/rollups/hmac-sha1.js"></script>
  <script src="../../../jsrsasign/lib/jsrsasign-rsa-min.js"></script>

</head>

<body>
  <test-fixture id="Basic">
    <template>
      <api-documentation></api-documentation>
    </template>
  </test-fixture>

  <script type="module">
  import '../api-documentation.js';
  /* global AmfLoader */
  suite('SE-11415', () => {
    [
      ['Full model', false],
      ['Compact model', true]
    ].forEach((item) => {
      suite(item[0], () => {
        let element;
        let amf;
        suiteSetup(() => {
          return AmfLoader.load(item[1], 'SE-11415')
          .then((data) => {
            amf = data;
          });
        });

        setup(() => {
          element = fixture('Basic');
          element.amfModel = amf;
        });

        test('declares is undefined', () => {
          assert.isUndefined(element.declares);
        });

        test('references is computed', () => {
          assert.typeOf(element.references, 'array');
          assert.lengthOf(element.references, 9);
        });

        function getSecurity(element, references) {
          for (let i = 0, len = references.length; i < len; i++) {
            if (!element._hasType(references[i], element.ns.raml.vocabularies.document + 'Module')) {
              continue;
            }
            const declares = element._computeDeclares(references[i]);
            if (!declares) {
              continue;
            }
            for (let j = 0; j < declares.length; j++) {
              let item = declares[j];
              if (item instanceof Array) {
                item = item[0];
              }
              if (element._hasType(item, element.ns.raml.vocabularies.security + 'SecurityScheme')) {
                return item;
              }
            }
          }
        }

        test('Computes security from fragment', () => {
          const sec = getSecurity(element, element.references);
          const id = sec['@id'];
          const result = element._computeSecurityModel(undefined, element.references, id);
          assert.typeOf(result, 'object');
        });
      });
    });
  });
  </script>
</body>

</html>
